version: '3.8'

#
# Docker Compose para VPS Master
# Inclui todos os serviços: PostgreSQL, Redis, Lookup, Baileys, Backend, Frontend
#

services:
  # ===========================================
  # BANCO DE DADOS PRINCIPAL
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: whatize_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-whatize}
      POSTGRES_USER: ${DB_USER:-whatize}
      POSTGRES_PASSWORD: ${DB_PASS:?Defina DB_PASS no .env}
      TZ: America/Sao_Paulo
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d:ro
    networks:
      - whatize_net
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-whatize} -d ${DB_NAME:-whatize}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "whatize=true"
      - "whatize.service=postgres"

  # ===========================================
  # BANCO DE DADOS DO LOOKUP SERVICE
  # ===========================================
  postgres-lookup:
    image: postgres:15-alpine
    container_name: whatize_postgres_lookup
    restart: unless-stopped
    environment:
      POSTGRES_DB: lookup_service
      POSTGRES_USER: lookup_user
      POSTGRES_PASSWORD: ${LOOKUP_DB_PASS:?Defina LOOKUP_DB_PASS no .env}
      TZ: America/Sao_Paulo
    volumes:
      - postgres_lookup_data:/var/lib/postgresql/data
    networks:
      - whatize_net
    ports:
      - "${LOOKUP_DB_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lookup_user -d lookup_service"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "whatize=true"
      - "whatize.service=postgres-lookup"

  # ===========================================
  # REDIS PRINCIPAL (Filas, Cache, Sessions)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: whatize_redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASS:?Defina REDIS_PASS no .env}
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - whatize_net
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASS}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "whatize=true"
      - "whatize.service=redis"

  # ===========================================
  # REDIS DO BAILEYS SERVICE (Auth State)
  # ===========================================
  redis-baileys:
    image: redis:7-alpine
    container_name: whatize_redis_baileys
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_baileys_data:/data
    networks:
      - whatize_net
    ports:
      - "${REDIS_BAILEYS_PORT:-6380}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "whatize=true"
      - "whatize.service=redis-baileys"

  # ===========================================
  # LOOKUP SERVICE (API Gateway / Roteamento)
  # ===========================================
  lookup:
    build:
      context: ${WHATIZE_PATH:-.}/lookup-service
      dockerfile: Dockerfile
    image: whatize-lookup:${VERSION:-latest}
    container_name: whatize_lookup
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3500
      DB_HOST: postgres-lookup
      DB_PORT: 5432
      DB_NAME: lookup_service
      DB_USER: lookup_user
      DB_PASS: ${LOOKUP_DB_PASS}
      ADMIN_API_KEY: ${LOOKUP_API_KEY:?Defina LOOKUP_API_KEY no .env}
      FRONTEND_URL: ${FRONTEND_URL}
      TZ: America/Sao_Paulo
    depends_on:
      postgres-lookup:
        condition: service_healthy
    networks:
      - whatize_net
    ports:
      - "${LOOKUP_PORT:-3500}:3500"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "whatize=true"
      - "whatize.service=lookup"

  # ===========================================
  # BAILEYS SERVICE (WhatsApp Integration)
  # ===========================================
  baileys:
    build:
      context: ${WHATIZE_PATH:-.}/BaileysService
      dockerfile: Dockerfile
    image: whatize-baileys:${VERSION:-latest}
    container_name: whatize_baileys
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3001
      REDIS_URI: redis://redis-baileys:6379
      API_KEY_SECRET: ${BAILEYS_API_KEY:-whatize-baileys-secret}
      WHATIZE_WEBHOOK_TOKEN: ${BAILEYS_WEBHOOK_TOKEN}
      CORS_ORIGINS: ${FRONTEND_URL},${BACKEND_URL}
      LOG_LEVEL: info
      TZ: America/Sao_Paulo
    depends_on:
      redis-baileys:
        condition: service_healthy
    networks:
      - whatize_net
    ports:
      - "${BAILEYS_PORT:-3001}:3001"
    volumes:
      - baileys_storage:/app/storage
      - baileys_logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "whatize=true"
      - "whatize.service=baileys"

  # ===========================================
  # BACKEND (Instância Principal)
  # ===========================================
  backend:
    build:
      context: ${WHATIZE_PATH:-.}/backend
      dockerfile: Dockerfile.optimized
    image: whatize-backend:${VERSION:-latest}
    container_name: whatize_backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      # Database
      DB_DIALECT: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-whatize}
      DB_USER: ${DB_USER:-whatize}
      DB_PASS: ${DB_PASS}
      # Redis
      REDIS_URI: redis://default:${REDIS_PASS}@redis:6379
      REDIS_OPT_MAX_RECONNECT_ATTEMPTS: 10
      # JWT
      JWT_SECRET: ${JWT_SECRET:?Defina JWT_SECRET no .env}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?Defina JWT_REFRESH_SECRET no .env}
      # URLs
      FRONTEND_URL: ${FRONTEND_URL}
      BACKEND_URL: ${BACKEND_URL}
      # Baileys Service
      BAILEYS_SERVICE_URL: http://baileys:3001
      BAILEYS_API_KEY: ${BAILEYS_API_KEY:-whatize-baileys-secret}
      BAILEYS_WEBHOOK_TOKEN: ${BAILEYS_WEBHOOK_TOKEN}
      # Lookup Service
      LOOKUP_API_URL: http://lookup:3500
      LOOKUP_API_KEY: ${LOOKUP_API_KEY}
      # Instance
      INSTANCE_CODE: ${INSTANCE_CODE:-0001}
      INSTANCE_NAME: ${INSTANCE_NAME:-Principal}
      COMPANY_ID: 1
      # Misc
      ENV_TOKEN: ${ENV_TOKEN:-wtV}
      TZ: America/Sao_Paulo
      NODE_OPTIONS: "--max-old-space-size=2048"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      lookup:
        condition: service_healthy
      baileys:
        condition: service_healthy
    networks:
      - whatize_net
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    volumes:
      - backend_public:/app/public
      - backend_logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "whatize=true"
      - "whatize.service=backend"
      - "whatize.instance=${INSTANCE_CODE:-0001}"
    mem_limit: 2g
    memswap_limit: 3g

  # ===========================================
  # FRONTEND (React + Nginx)
  # ===========================================
  frontend:
    build:
      context: ${WHATIZE_PATH:-.}/frontend
      dockerfile: Dockerfile.optimized
      args:
        REACT_APP_BACKEND_URL: ${BACKEND_URL}
        REACT_APP_LOOKUP_URL: ${LOOKUP_URL}
        REACT_APP_HOURS_CLOSE_TICKETS_AUTO: 24
    image: whatize-frontend:${VERSION:-latest}
    container_name: whatize_frontend
    restart: unless-stopped
    networks:
      - whatize_net
    ports:
      - "${FRONTEND_PORT:-3333}:80"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "whatize=true"
      - "whatize.service=frontend"

# ===========================================
# REDE
# ===========================================
networks:
  whatize_net:
    name: whatize_net
    external: true

# ===========================================
# VOLUMES
# ===========================================
volumes:
  postgres_data:
    name: whatize_postgres_data
  postgres_lookup_data:
    name: whatize_postgres_lookup_data
  redis_data:
    name: whatize_redis_data
  redis_baileys_data:
    name: whatize_redis_baileys_data
  backend_public:
    name: whatize_backend_public
  backend_logs:
    name: whatize_backend_logs
  baileys_storage:
    name: whatize_baileys_storage
  baileys_logs:
    name: whatize_baileys_logs
